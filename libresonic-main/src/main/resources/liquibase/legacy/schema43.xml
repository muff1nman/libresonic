<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <changeSet id="schema43_001" author="muff1nman">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">select count(*) from version where version = 16</sqlCheck>
        </preConditions>
        <insert tableName="VERSION">
            <column name="VERSION" valueNumeric="16" />
        </insert>
        <rollback>
            <delete tableName="VERSION" >
                <where>version = 16</where>
            </delete>
        </rollback>
    </changeSet>
    <changeSet id="schema43_002" author="muff1nman">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">select count(*) from version where version = 17</sqlCheck>
        </preConditions>
        <insert tableName="VERSION">
            <column name="VERSION" valueNumeric="17" />
        </insert>
        <delete tableName="TRANSCODING">
            <where>target_format = flv and source_format in ('avi', 'mpg', 'mpeg', 'mp4', 'm4v', 'mkv', 'mov', 'wmv', 'ogv')</where>
        </delete>
        <insert tableName="TRANSCODING">
            <column name="NAME" value="avi > flv"/>
            <column name="SOURCE_FORMAT" value="avi" />
            <column name="TARGET_FORMAT" value="flv" />
            <column name="STEP1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f flv -" />
            <column name="ENABLED" valueBoolean="true" />
        </insert>
        <sql>
            insert into "PLAYER_TRANSCODING"(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from "PLAYER" p, "TRANSCODING" t where t.name = 'avi > flv'
        </sql>
        <insert tableName="TRANSCODING">
            <column name="NAME" value="mpg > flv"/>
            <column name="SOURCE_FORMAT" value="mpg" />
            <column name="TARGET_FORMAT" value="flv" />
            <column name="STEP1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f flv -" />
            <column name="ENABLED" valueBoolean="true" />
        </insert>
        <sql>
            insert into "PLAYER_TRANSCODING"(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from "PLAYER" p, "TRANSCODING" t where t.name = 'mpg > flv'
        </sql>
        <insert tableName="TRANSCODING">
            <column name="NAME" value="mpeg > flv"/>
            <column name="SOURCE_FORMAT" value="mpeg" />
            <column name="TARGET_FORMAT" value="flv" />
            <column name="STEP1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f flv -" />
            <column name="ENABLED" valueBoolean="true" />
        </insert>
        <sql>
            insert into "PLAYER_TRANSCODING"(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from "PLAYER" p, "TRANSCODING" t where t.name = 'mpeg > flv'
        </sql>
        <insert tableName="TRANSCODING">
            <column name="NAME" value="mp4 > flv"/>
            <column name="SOURCE_FORMAT" value="mp4" />
            <column name="TARGET_FORMAT" value="flv" />
            <column name="STEP1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f flv -" />
            <column name="ENABLED" valueBoolean="true" />
        </insert>
        <sql>
            insert into "PLAYER_TRANSCODING"(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from "PLAYER" p, "TRANSCODING" t where t.name = 'mp4 > flv'
        </sql>
        <insert tableName="TRANSCODING">
            <column name="NAME" value="m4v > flv"/>
            <column name="SOURCE_FORMAT" value="m4v" />
            <column name="TARGET_FORMAT" value="flv" />
            <column name="STEP1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f flv -" />
            <column name="ENABLED" valueBoolean="true" />
        </insert>
        <sql>
            insert into "PLAYER_TRANSCODING"(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from "PLAYER" p, "TRANSCODING" t where t.name = 'm4v > flv'
        </sql>
        <insert tableName="TRANSCODING">
            <column name="NAME" value="mkv > flv"/>
            <column name="SOURCE_FORMAT" value="mkv" />
            <column name="TARGET_FORMAT" value="flv" />
            <column name="STEP1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f flv -" />
            <column name="ENABLED" valueBoolean="true" />
        </insert>
        <sql>
            insert into "PLAYER_TRANSCODING"(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from "PLAYER" p, "TRANSCODING" t where t.name = 'mkv > flv'
        </sql>
        <insert tableName="TRANSCODING">
            <column name="NAME" value="mov > flv"/>
            <column name="SOURCE_FORMAT" value="mov" />
            <column name="TARGET_FORMAT" value="flv" />
            <column name="STEP1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f flv -" />
            <column name="ENABLED" valueBoolean="true" />
        </insert>
        <sql>
            insert into "PLAYER_TRANSCODING"(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from "PLAYER" p, "TRANSCODING" t where t.name = 'mov > flv'
        </sql>
        <insert tableName="TRANSCODING">
            <column name="NAME" value="wmv > flv"/>
            <column name="SOURCE_FORMAT" value="wmv" />
            <column name="TARGET_FORMAT" value="flv" />
            <column name="STEP1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f flv -" />
            <column name="ENABLED" valueBoolean="true" />
        </insert>
        <sql>
            insert into "PLAYER_TRANSCODING"(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from "PLAYER" p, "TRANSCODING" t where t.name = 'wmv > flv'
        </sql>
        <insert tableName="TRANSCODING">
            <column name="NAME" value="ogv > flv"/>
            <column name="SOURCE_FORMAT" value="ogv" />
            <column name="TARGET_FORMAT" value="flv" />
            <column name="STEP1" value="ffmpeg -ss %o -i %s -async 1 -b %bk -s %wx%h -ar 44100 -ac 2 -v 0 -f flv -" />
            <column name="ENABLED" valueBoolean="true" />
        </insert>
        <sql>
            insert into "PLAYER_TRANSCODING"(player_id, transcoding_id) select p.id as player_id, t.id as transaction_id from "PLAYER" p, "TRANSCODING" t where t.name = 'ogv > flv'
        </sql>
        <rollback/>
    </changeSet>
    <changeSet id="schema43_003" author="muff1nman">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="USER" columnName="EMAIL" />
            </not>
        </preConditions>
        <addColumn tableName="USER">
            <column name="EMAIL" type="${varchar_type}"/>
        </addColumn>
    </changeSet>
</databaseChangeLog>
